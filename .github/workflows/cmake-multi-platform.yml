name: Build and Release

on:
  push:
    tags: 
      - 'v*.*.*'

permissions:
  contents: write

jobs:


  # ======================
  # LINUX BUILD
  # ======================
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]

    steps:
      - uses: actions/checkout@v4

      - name: Prepare Raylib (Linux)
        run: |
          mkdir -p lib/raylib/
          curl -L https://github.com/raysan5/raylib/releases/download/5.5/raylib-5.5_linux_amd64.tar.gz -o raylib.tar.gz
          tar -xzf raylib.tar.gz
          mv raylib-5.5_linux_amd64/* lib/raylib/

      - name: Configure CMake
        run: cmake -B build/ -G Ninja -S . -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build/ -j

      - name: Prepare release files
        run: |
          mkdir release
          cp -r build/Aloha release/
          cp -r romfs/ release/

      - name: Compress release files
        run: tar -czf Aloha-Linux_${{ matrix.compiler }}.tar.gz release/

      - uses: actions/upload-artifact@v4
        with:
          name: Aloha-Linux-${{ matrix.compiler }}
          path: Aloha-Linux_${{ matrix.compiler }}.tar.gz


  # ======================
  # WINDOWS BUILD
  # ======================
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: msvc
            raylib_url: https://github.com/raysan5/raylib/releases/download/5.5/raylib-5.5_win64_msvc16.zip
            artifact_name: Aloha-Windows-MSVC.zip
            setup_msys: false

          - name: mingw
            raylib_url: https://github.com/raysan5/raylib/releases/download/5.5/raylib-5.5_win64_mingw-w64.zip
            artifact_name: Aloha-Windows-mingw64.zip
            setup_msys: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 (only for MinGW)
        if: ${{ matrix.setup_msys }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            git
            cmake
            ninja
          pacboy: toolchain:p

      - name: Prepare Raylib
        run: |
          mkdir -p lib/raylib/
          curl -L ${{ matrix.raylib_url }} -o raylib.zip
          Expand-Archive raylib.zip
          mv raylib-*/* lib/raylib/

      - name: Configure CMake
        run: |
          if ("${{ matrix.name }}" -eq "msvc") {
            cmake -B build/ -S . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          } else {
            cmake -B build/ -S . -G Ninja -DCMAKE_BUILD_TYPE=Release
          }

      - name: Build
        run: |
          if ("${{ matrix.name }}" -eq "msvc") {
            cmake --build build/ --config Release --parallel
          } else {
            cmake --build build/ -j
          }

      - name: Prepare release files
        run: |
          mkdir release
          if ("${{ matrix.name }}" -eq "msvc") {
            cp build/Release/Aloha.exe release/
          } else {
            cp build/Aloha.exe release/
          }
          cp lib/raylib/raylib.dll release/
          cp -r romfs/ release/

      - name: Compress release files
        run: |
          Compress-Archive -Path release -DestinationPath ${{ matrix.artifact_name }} -Force

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}


  # ======================
  # RELEASE
  # ======================
  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: "Automatic multi-platform build of ${{ github.ref_name }}"
          files: ./artifacts/**
          prerelease: false
